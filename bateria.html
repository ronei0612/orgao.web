<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bateria Online</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: sans-serif;
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .track {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

            .track label {
                width: 120px;
                text-align: right;
                margin-right: 10px;
            }

        .step {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            margin-right: 5px;
            cursor: pointer;
            text-align: center;
            line-height: 30px;
        }

            .step.active {
                background-color: #198754;
                color: white;
            }

            .step.playing {
                background-color: #ffc107;
            }

            .step.active.playing {
                background-color: #28a745;
            }

        .rhythm-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

            .rhythm-buttons button {
                width: 50px;
            }

                .rhythm-buttons button.selected {
                    background-color: #007bff;
                    color: white;
                }

        .rhythm-button.pending {
            animation: blinker 1s linear infinite;
        }

        .track label i {
            font-size: 1.5em; /* Ajuste o tamanho do ícone */
            margin-right: 5px; /* Adicione um espaço entre o ícone e os passos */
            vertical-align: middle; /* Alinhe verticalmente o ícone com os passos */
        }

        .step.low-volume {
            background-color: #8fbc8f; /* Cor verde mais clara para low volume */
            color: white;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Bateria Online</h1>

        <div class="rhythm-buttons">
            <button id="rhythm-a" class="btn btn-secondary rhythm-button">A</button>
            <button id="rhythm-b" class="btn btn-secondary rhythm-button">B</button>
            <button id="rhythm-c" class="btn btn-secondary rhythm-button">C</button>
            <button id="rhythm-d" class="btn btn-secondary rhythm-button">D</button>
            <button id="save-rhythm" class="btn btn-primary" style="width:auto">Salvar</button>
        </div>

        <div class="controls">
            <button id="play-pause" class="btn btn-success">Play</button>
            <input type="number" id="bpm" value="90" class="form-control" style="width: 70px;">
            <input type="number" id="num-steps" value="4" class="form-control" style="width: 70px;">
            <button id="clear" class="btn btn-danger">Limpar</button>
        </div>

        <div id="tracks">
        </div>

    </div>

    <script src="assets/js/DrumMachine.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const drumMachine = new DrumMachine();
            await drumMachine.init();

            const playPauseButton = document.getElementById('play-pause');
            const bpmInput = document.getElementById('bpm');
            const clearButton = document.getElementById('clear');
            const tracksContainer = document.getElementById('tracks');
            const numStepsInput = document.getElementById('num-steps');

            const rhythmAButton = document.getElementById('rhythm-a');
            const rhythmBButton = document.getElementById('rhythm-b');
            const rhythmCButton = document.getElementById('rhythm-c');
            const rhythmDButton = document.getElementById('rhythm-d');
            const saveRhythmButton = document.getElementById('save-rhythm');

            let selectedRhythm = 'A';
            let pendingRhythm = null;
            let pendingButton = null;

            // Função para criar uma linha de instrumento
            function createTrack(instrument) {
                const track = document.createElement('div');
                track.classList.add('track');

                const label = document.createElement('label');
                label.innerHTML = `${instrument.name} <i class="${instrument.icon}" title="${instrument.name}"></i>`;
                track.appendChild(label);

                const currentSteps = parseInt(numStepsInput.value);
                for (let i = 1; i <= currentSteps; i++) {
                    const step = document.createElement('div');
                    step.classList.add('step');
                    step.textContent = i;
                    step.dataset.step = i;
                    step.dataset.volume = 0; // 0: off, 1: full, 2: low
                    step.addEventListener('click', toggleStep);
                    track.appendChild(step);
                }

                tracksContainer.appendChild(track);
            }

            // Função para inicializar as tracks
            function initializeTracks() {
                tracksContainer.innerHTML = '';
                drumMachine.instruments.forEach(createTrack);
            }

            initializeTracks();

            // Função para ativar/desativar um passo
            function toggleStep(event) {
                const step = event.target;
                let volume = parseInt(step.dataset.volume);

                volume = (volume + 1) % 3; // Cicla entre 0, 1, 2
                step.dataset.volume = volume;

                step.classList.remove('active', 'low-volume');

                if (volume === 1) {
                    step.classList.add('active');
                } else if (volume === 2) {
                    step.classList.add('low-volume');
                }
            }

            // Configurar callback para troca de ritmo
            drumMachine.onMeasureEnd = () => {
                if (pendingRhythm) {
                    loadRhythm(`rhythm-${pendingRhythm}`);
                    pendingRhythm = null;
                    if (pendingButton) {
                        pendingButton.classList.remove('pending');
                        pendingButton = null;
                    }
                }
            };

            // Função para iniciar/parar a reprodução
            function togglePlay() {
                if (!drumMachine.isPlaying) {
                    drumMachine.start();
                    playPauseButton.textContent = 'Pause';
                } else {
                    drumMachine.stop();
                    playPauseButton.textContent = 'Play';
                }
            }

            // Função para salvar o ritmo no localStorage
            function saveRhythm() {
                const rhythmData = {};
                document.querySelectorAll('.track').forEach(track => {
                    const instrument = track.querySelector('label i').title.toLowerCase().replace(/ /g, '');
                    const stepsData = [];
                    track.querySelectorAll('.step').forEach(step => {
                        stepsData.push(parseInt(step.dataset.volume));
                    });
                    rhythmData[instrument] = stepsData;
                });
                localStorage.setItem(`rhythm-${selectedRhythm}`, JSON.stringify(rhythmData));
                console.log(`Ritmo ${selectedRhythm} salvo!`);
            }

            // Função para carregar o ritmo do localStorage
            function loadRhythm(rhythmKey) {
                const savedRhythm = localStorage.getItem(rhythmKey);
                if (savedRhythm) {
                    const rhythmData = JSON.parse(savedRhythm);
                    document.querySelectorAll('.track').forEach(track => {
                        const instrument = track.querySelector('label i').title.toLowerCase().replace(/ /g, '');
                        const stepsData = rhythmData[instrument] || [];

                        track.querySelectorAll('.step').forEach((step, index) => {
                            const volume = stepsData[index] !== undefined ? stepsData[index] : 0;
                            step.dataset.volume = volume;
                            step.classList.remove('active', 'low-volume');

                            if (volume === 1) {
                                step.classList.add('active');
                            } else if (volume === 2) {
                                step.classList.add('low-volume');
                            }
                        });
                    });
                }
                else {
                    // faça clicar no botão clearButton
                    clearButton.dispatchEvent(new Event('click'));
                }
            }

            // Função para selecionar um botão de ritmo
            function selectRhythm(rhythmButton, rhythmKey) {
                if (pendingButton) {
                    pendingButton.classList.remove('pending');
                }

                document.querySelectorAll('.rhythm-button').forEach(button => {
                    button.classList.remove('selected');
                });
                rhythmButton.classList.add('selected');
                pendingRhythm = rhythmKey.replace('rhythm-', '').toUpperCase(); // Define o ritmo pendente
                selectedRhythm = rhythmKey.replace('rhythm-', '').toUpperCase();
                rhythmButton.classList.add('pending'); // Adiciona a classe de piscar
                pendingButton = rhythmButton;
            }

            // Event listeners para os botões de ritmo
            rhythmAButton.addEventListener('click', () => selectRhythm(rhythmAButton, 'rhythm-a'));
            rhythmBButton.addEventListener('click', () => selectRhythm(rhythmBButton, 'rhythm-b'));
            rhythmCButton.addEventListener('click', () => selectRhythm(rhythmCButton, 'rhythm-c'));
            rhythmDButton.addEventListener('click', () => selectRhythm(rhythmDButton, 'rhythm-d'));

            // Event listener para o botão de salvar
            saveRhythmButton.addEventListener('click', saveRhythm);

            playPauseButton.addEventListener('click', togglePlay);

            bpmInput.addEventListener('change', () => {
                const bpm = parseInt(bpmInput.value);
                drumMachine.setBPM(bpm);
            });

            clearButton.addEventListener('click', () => {
                document.querySelectorAll('.step.active').forEach(step => {
                    step.classList.remove('active');
                });
                document.querySelectorAll('.step.low-volume').forEach(step => {
                    step.classList.remove('low-volume');
                });
            });

            numStepsInput.addEventListener('change', () => {
                const steps = parseInt(numStepsInput.value);
                drumMachine.setNumSteps(steps);
                initializeTracks();
            });

            // Carregar o ritmo selecionado ao carregar a página
            document.querySelectorAll('.rhythm-button').forEach(button => {
                button.classList.remove('selected');
            });
            rhythmAButton.classList.add('selected');
            loadRhythm('rhythm-A');
        });
    </script>
</body>

</html>