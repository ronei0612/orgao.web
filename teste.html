<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Audio</title>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 30px;
            background-color: #f4f4f9;
            color: #333;
        }

        h1 {
            color: #007bff;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .play-button, #stopButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: 2px solid #ccc;
            background-color: #ffffff;
            border-radius: 5px;
            transition: all 0.2s ease-in-out;
            min-width: 120px;
        }

            .play-button:hover:not(:disabled) {
                background-color: #e9ecef;
                border-color: #007bff;
            }

            .play-button.active {
                background-color: #28a745;
                color: white;
                border-color: #28a745;
            }

            .play-button:disabled, #stopButton:disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }

        #statusMessage {
            margin-top: 25px;
            font-style: italic;
            color: #555;
            min-height: 20px;
        }

        .controls-group {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: inline-block;
        }

        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>Controle de Acordes Otimizado (Web Audio)</h1>

    <div class="controls-group">

        <div class="button-group">
            <button id="playCButton" class="play-button" disabled>Play C</button>
            <button id="playGButton" class="play-button" disabled>Play G</button>
            <button id="stopButton" disabled>Stop</button>
        </div>
    </div>

    <p id="statusMessage">Carregando recursos de áudio, por favor aguarde...</p>

    <script>
        // --- Configuração das URLs ---
        const audioConfigs = {
            'C': {
                urls: [
                    'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_c.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_e.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_g.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_c_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_e_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_g_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_c_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_e_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_g_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_c.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_e.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_g.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_c_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_e_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_g_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_c_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_e_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_g_baixo.ogg'
                ],
                sources: [],
                gainNode: null
            },
            'G': {
                urls: [
                    'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_g.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_b.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_d.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_g_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_b_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_d_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_g_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_b_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Orgao/orgao_d_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_g.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_b.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_d.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_g_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_b_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_d_grave.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_g_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_b_baixo.ogg', 'https://roneicostasoares.com.br/orgao.web/assets/audio/Strings/strings_d_baixo.ogg'
                ],
                sources: [],
                gainNode: null
            }
        };

        const ATTACK_TIME = 0.2;
        const RELEASE_TIME = 0.5;
        const PEAK_VOLUME = 0.5;

        // --- Variáveis Globais ---
        let audioContext;
        let masterGainNode;
        let currentAcorde = null;
        let urlBufferMap = new Map();

        // --- Elementos HTML ---
        const playCButton = document.getElementById('playCButton');
        const playGButton = document.getElementById('playGButton');
        const stopButton = document.getElementById('stopButton');
        const statusMessage = document.getElementById('statusMessage');
        const allPlayButtons = [playCButton, playGButton];

        const buttonMap = { 'playCButton': 'C', 'playGButton': 'G' };

        // Inicializa o AudioContext e o Master Gain Node
        function initializeContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGainNode = audioContext.createGain();
                masterGainNode.connect(audioContext.destination);
                masterGainNode.gain.setValueAtTime(PEAK_VOLUME, audioContext.currentTime);

                // Cria os Gain Nodes individuais e os conecta ao Master Gain
                for (const acorde in audioConfigs) {
                    const config = audioConfigs[acorde];
                    config.gainNode = audioContext.createGain();
                    config.gainNode.connect(masterGainNode);
                    config.gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                }
            }
        }

        // Função assíncrona para carregar e decodificar um arquivo de áudio
        async function loadAudio(url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                if (!audioContext) initializeContext();
                return audioContext.decodeAudioData(arrayBuffer);
            } catch (error) {
                console.error(`Falha ao carregar ou decodificar: ${url}`, error);
                throw new Error(`Erro ao carregar o áudio de: ${url}`);
            }
        }

        // Função principal de pré-carregamento (Otimizada para URLs únicas)
        async function preloadAllAudio() {
            initializeContext();

            try {
                // ... (lógica de carregamento de URLs únicas) ...
                const allUrlsSet = new Set();
                for (const acorde in audioConfigs) {
                    audioConfigs[acorde].urls.forEach(url => allUrlsSet.add(url));
                }
                const uniqueUrls = Array.from(allUrlsSet);
                const loadingPromises = uniqueUrls.map(url => loadAudio(url));
                const allBuffers = await Promise.all(loadingPromises);

                uniqueUrls.forEach((url, index) => {
                    urlBufferMap.set(url, allBuffers[index]);
                });

                statusMessage.textContent = 'Carregamento concluído! Pronto para tocar.';
                updateButtonStates(null, false);

            } catch (error) {
                statusMessage.textContent = `Erro fatal no carregamento: ${error.message}. Recarregue a página.`;
                console.error(error);
            }
        }

        // Função para atualizar o estado visual dos botões
        function updateButtonStates(currentAcordeKey, isTransitioning = false) {
            allPlayButtons.forEach(button => {
                const acorde = buttonMap[button.id];

                const isDisabled = isTransitioning;

                button.disabled = isDisabled;
                button.classList.remove('active');

                if (acorde === currentAcordeKey && !isTransitioning) {
                    button.textContent = `Tocando ${acorde}...`;
                    button.classList.add('active');
                } else if (isTransitioning) {
                    button.textContent = 'Transição...';
                } else {
                    button.textContent = `Play ${acorde}`;
                }
            });
            stopButton.disabled = currentAcordeKey === null;
        }

        /**
         * Para o som de um acorde específico com fade-out e liberação de recursos.
         * @param {string} acorde - A chave do acorde ('C' ou 'G').
         */
        function stopAndCleanupAcorde(acorde) {
            return new Promise(resolve => {
                const config = audioConfigs[acorde];
                if (!config.gainNode) return resolve();

                const stopTime = audioContext.currentTime + RELEASE_TIME;

                // APLICA O FADE-OUT NO NÓ DE GANHO INDIVIDUAL
                config.gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                config.gainNode.gain.linearRampToValueAtTime(0.0001, stopTime);

                // Agenda a parada das SourceNodes e a limpeza do estado APÓS o fade-out
                setTimeout(() => {
                    config.sources.forEach(source => {
                        try { source.stop(0); } catch (e) { /* ignore se já parou */ }
                    });
                    config.sources = [];
                    resolve();
                }, RELEASE_TIME * 1000);
            });
        }

        // Função principal para iniciar a reprodução
        async function startSound(acorde) {
            // ** CORREÇÃO: Tenta resumir/iniciar o contexto IMEDIATAMENTE no clique **
            if (!audioContext || audioContext.state === 'suspended') {
                initializeContext(); // Cria o contexto e os nós se ainda não existirem
                audioContext.resume().catch(e => console.error("Falha ao resumir o AudioContext:", e));
            }

            if (acorde === currentAcorde) {
                return;
            }

            const previousAcorde = currentAcorde;
            currentAcorde = acorde;

            const newConfig = audioConfigs[acorde];
            const newGainNode = newConfig.gainNode;
            const now = audioContext.currentTime;

            // 1. INICIAR O FADE-OUT NO ACORDE ANTERIOR (ocorre em paralelo - Cross-Fade)
            if (previousAcorde) {
                stopAndCleanupAcorde(previousAcorde);
                statusMessage.textContent = `Transição Cross-Fade: ${previousAcorde} -> ${acorde}...`;
            }

            try {
                // 2. INICIAR O NOVO SOM (se ainda não estiver rodando)
                if (newConfig.sources.length === 0) {
                    // ... (lógica de criação de sources) ...
                    newConfig.sources = [];
                    newConfig.urls.forEach(url => {
                        const buffer = urlBufferMap.get(url);
                        if (!buffer) { throw new Error(`Buffer não encontrado para URL: ${url}`); }

                        const source = audioContext.createBufferSource();
                        source.buffer = buffer;
                        source.loop = true;
                        source.connect(newGainNode);
                        source.start(0);

                        newConfig.sources.push(source);
                    });
                }

                // 3. Efeito Attack (Fade-in gradual) APLICADO NO GANHO INDIVIDUAL DO NOVO ACORDE
                newGainNode.gain.cancelScheduledValues(now);

                // ** A CORREÇÃO: Garante que o valor inicial do fade-in seja 0, mesmo após resume **
                newGainNode.gain.setValueAtTime(0, now);

                // Rampa até o volume máximo (1.0 no nó individual, pois o Master Gain gerencia o volume global)
                newGainNode.gain.linearRampToValueAtTime(1.0, now + ATTACK_TIME);

                // 4. Gerenciar botões e status
                updateButtonStates(acorde, false);
                statusMessage.textContent = `Cross-Fade completo. Acorde de ${acorde} tocando. Volume Mestre: ${(PEAK_VOLUME * 100).toFixed(0)}%.`;

            } catch (error) {
                // Em caso de erro
                console.error(error);
                updateButtonStates(null, false);
                statusMessage.textContent = `Erro durante a reprodução: ${error.message}`;
                currentAcorde = null;
            }
        }

        // Função do botão Stop (parada total)
        async function stopAll() {
            if (!currentAcorde) return;

            // 1. Feedback visual de parada
            updateButtonStates(null, true);
            statusMessage.textContent = `Parando reprodução... (Fade-out em ${RELEASE_TIME}s)`;

            // 2. Executa o fade-out
            await stopAndCleanupAcorde(currentAcorde);

            // 3. Limpeza final e atualização do estado
            currentAcorde = null;
            updateButtonStates(null, false);
            statusMessage.textContent = 'Reprodução parada. Contexto de áudio suspenso.';

            // Suspende o AudioContext para economizar recursos (opcional)
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.suspend();
            }
        }

        // --- Listeners de Evento ---
        window.addEventListener('load', preloadAllAudio);

        playCButton.addEventListener('click', () => startSound('C'));
        playGButton.addEventListener('click', () => startSound('G'));
        stopButton.addEventListener('click', stopAll);

    </script>
</body>
</html>